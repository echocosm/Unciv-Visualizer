<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: "Roboto", system-ui;
        font-style: normal;
      }
      .tech-tree-container {
        display: flex;
        justify-content: flex-start;
        flex-wrap: nowrap;
        //padding: 40px;
        background-color: white;
        position: relative;
        pointer-events: auto; /* Default state allows interaction */
      }
      .tech-tree-container.freeze {
        pointer-events: none; /* Default state allows interaction */
      }
      .tech-era-header-group {
        display: flex;
        flex-direction: column;
        //margin-bottom: 40px;
        width: 100%;
        background-color: white;
      }
      .tech-era-header {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
      }
      .tech-era-group-container {
        display: flex;
        flex-direction: row;
        position: relative;
      }
      .tech-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 30px;
        min-width: 200px;
        position: relative;
        height: 550px;
      }
      #tree-branch:hover, #tree-branch:active  {
        background-color: #aaffff;
        border:medium solid cyan;
        transition: background-color 0.3s, border 0.3s;
        text-shadow: 2px 2px 1px cyan;
      }
      #tree-branch {
        width: 160px;
        height: 40px;
      }
      .techboxitem {
        border: medium solid blue;
        background-color: #72bcd3;
        margin: 5px; //for some reason this only effects it inside the popup
        padding: 1px;//30px;
        border-radius: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: row-reverse;
        justify-content: left;
        align-items: center;
        z-index: 3;
      }
      .tech-popup {
        display: none;
        position: fixed;
        top: 0%;
        left: 50%;
        transform: translateX(-50%);
        width: 800px;
        padding: 20px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        height: 750px;
        overflow-y: auto;
        z-index: 10;
        align-items: center;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .line {
        position: absolute;
        background-color: blue;
        width: 4px;
        height: 4px;
        z-index: 1;
        border-radius: 2px;
        align: center;
        justify: center;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .line-hovered {
        background-color: cyan;
        z-index: 2;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .no-hover .techboxitem {
        pointer-events: none;
      }
      .no-hover .techboxitem.hovered, .no-hover .line-hovered {
        background-color: #aaffff;
        border-color: cyan;
      }
      .close-btn {
        border: medium solid blue;
        background-color: #72bcd3;
        border-radius: 5px;
        margin: 5px 0;
        padding: 10px;
        font-size: 16px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 10;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .close-btn:hover {
        background-color: #aaffff;
        border-color: cyan;
        text-shadow: 2px 2px 1px cyan;
        transition: background-color 0.3s, border-color 0.3s;
      }
      .blank {
        display: flex;
        flex-direction: row;
        margin: 0px ;
        padding: 0px;
        text-align: center;
        align-items: center;
      }
      .token-container {
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        margin: 5px;
      }
      .tech-icon {
        width: 20px;
        height: 20px;
      }
      .tech-name {
        display: flex;
        margin: 5px;
        white-space: nowrap; /* Prevent text wrapping */
        overflow: hidden; /* Prevent overflow */
        text-overflow: ellipsis; /* Ellipsis if text overflows */
        align-items: flex-start;
        font-size: 12px;
      }

      /* === BLANK === */
      .blank-style-box   {width: auto; justify-content: space-between; flex-direction: row; margin: 0px; padding: 0px; background-color: transparent; border-color: transparent; box-shadow: none}
      /* === QUOTE === */
      .quote-style-box   { flex-wrap: wrap; width: 100%; }
      .quote-style-text {
        font-style: italic;
        font-size: 18px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        text-align: center;}



      /* === NEGATIVE === */
      .negative-style-token { border-color: black; background-color: white; }

      /* === SCIENCE === */
      .science-style-box   { border-color: blue; background-color: #72bcd3; }
      .science-style-token { border-color: blue; background-color: white; }
      .science-style-text  { border-color: white; background-color: transparent; }

      /* === BLUE === */
      .blue-style-box   { border-color: blue; background-color: #72bcd3; }
      .blue-style-token { border-color: blue; background-color: #72bcd3; }
      .blue-style-text  { color: black; background-color: transparent; }

      /* === YELLOW (Brighter) === */
      .yellow-style-box   { border-color: #f1c40f; background-color: #fff9c4; }
      .yellow-style-token { border-color: #f1c40f; background-color: #fff9c4; }
      .yellow-style-text  { color: #b38f00; }

      /* === ORANGE === */
      .orange-style-box   { border-color: #ff7f0e; background-color: #ffe5cc; }
      .orange-style-token { border-color: #ff7f0e; background-color: #ffe5cc; }
      .orange-style-text  { color: #cc6600; }

      /* === PURPLE === */
      .purple-style-box   { border-color: #7e3ff2; background-color: #ebd9ff; }
      .purple-style-token { border-color: #7e3ff2; background-color: #ebd9ff; }
      .purple-style-text  { color: #4b179c; }

      /* === RED === */
      .red-style-box   { border-color: #d72f2f; background-color: #ffd6d6; }
      .red-style-token { border-color: #d72f2f; background-color: #ffd6d6; }
      .red-style-text  { color: #a11a1a; }

      /* === GREEN === */
      .green-style-box   { border-color: #2f9e44; background-color: #d8f5e0; }
      .green-style-token { border-color: #2f9e44; background-color: #d8f5e0; }
      .green-style-text  { color: #1c6b2c; }

      /* === GREY === */
      .grey-style-box   { border-color: #6c757d; background-color: #e9ecef; }
      .grey-style-token { border-color: #6c757d; background-color: #e9ecef; }
      .grey-style-text  { color: #343a40; }


    </style>
  </head>
  <body>
    <div id="techTree" class="tech-tree-container"></div>
    <div id="techPopup" class="tech-popup"></div>

    <script>

    let isPopupOpen = false, selectedTechItem = null;

    async function loadJsonFiles() {
      [techsData, buildingsData, unitsData, tileImprovementsData, nationsData] =
        await Promise.all([
          'Techs', 'Buildings', 'Units', 'TileImprovements', 'Nations'
        ].map(f => fetch(`jsons/${f}.json`).then(r => r.json())));
    }

    function delay(ms) {return new Promise(resolve => setTimeout(resolve, ms))};

    async function createTechTree() {
      const container = document.getElementById('techTree');
      container.innerHTML = '';
      document.body.style.overflowX = 'hidden';

      let lastEra = "", eraHeaderGroup, eraGroupContainer, isLightBlue = true;
      loadJsonFiles();
      for (const group of techsData) {
        await delay(1)
        if (group.era !== lastEra) {
          eraHeaderGroup = document.createElement('div');
          eraHeaderGroup.classList.add('tech-era-header-group');
          const eraHeader = document.createElement('div');
          eraHeader.classList.add('tech-era-header');
          eraHeader.innerText = group.era;
          eraHeader.style.backgroundColor = isLightBlue ? 'lightblue' : '#c0eaf7';
          eraHeaderGroup.appendChild(eraHeader);
          eraGroupContainer = document.createElement('div');
          eraGroupContainer.classList.add('tech-era-group-container');
          eraGroupContainer.id = "line-holder"
          eraHeaderGroup.appendChild(eraGroupContainer);
          container.appendChild(eraHeaderGroup);
          lastEra = group.era;
          isLightBlue = !isLightBlue;
        }

        const column = document.createElement('div');
        column.classList.add('tech-column');
        column.style.backgroundColor = isLightBlue ? 'lightblue' : '#c0eaf7';

        let positionTop = 0; // Start with an initial top position

        for (const tech of group.techs || []) {
          // Create the techItem and pass the vertical position
          await delay(1)
          const techItem = createTechItem("TechIcons",tech.name,tech.name,"blue",column,(tech.row*50)-50,null,null,"blue"); //#72bcd3
          techItem.id = "tree-branch"
          techItem.addEventListener('click', () => showTechDetails(tech, group, techItem));
        }
        eraGroupContainer.appendChild(column);
      }
      await delay(1);
      drawLinesForAllTechs();
      addHoverEffectToTechItems();
      document.body.style.overflowX = 'auto';  // Restore default horizontal scrolling
    };

    function drawLineBetweenTechs(techItem1, techItem2) {
      if (techItem1 && techItem2) {
        const height = 2*parseInt(getComputedStyle(document.querySelector('.techboxitem')).padding, 10);
        const [rect1, rect2] = [techItem1.getBoundingClientRect(), techItem2.getBoundingClientRect()];
        const [startX, startY, endX, endY] = [
          rect1.left + rect1.width / 2, (rect1.top+height) - (rect1.height / 2), 
          rect2.left + rect2.width / 2, (rect2.top+height) - (rect2.height / 2)
        ];
        const connectedTech = `${techItem1.dataset.techName}-${techItem2.dataset.techName}`;
        const createLine = (style) => {
          const line = document.createElement('div');
          line.classList.add('line');
          Object.assign(line.style, style);
          line.dataset.connectedTech = connectedTech;
          document.getElementById('line-holder').appendChild(line)};
        if (Math.abs(startY - endY) < 10) {
          createLine({ left: `${Math.min(startX, endX)}px`, top: `${startY}px`, width: `${Math.abs(endX - startX)}px`});
        } else {
          const halfwayX = (Math.abs(endX - startX) / 2), verticalHeight = Math.abs(endY - startY);
          const verticalDirection = (startY > endY) ? -1 : 1;
          createLine({left:`${startX}px`,top:`${startY}px`,width:`${halfwayX-12}px`});
          createLine({left:`${startX+halfwayX-8}px`,height:'23px',transform:`rotate(${verticalDirection===-1?'45':'-45'}deg)`,top:`${startY-(verticalDirection===-1?17:2)}px`});
          createLine({left:`${startX+halfwayX}px`,top:`${16+(verticalDirection===-1?endY:startY)}px`,height:`${verticalHeight-28}px`});
          createLine({left:`${startX+halfwayX+7}px`,height:'23px',transform:`rotate(${verticalDirection===-1?'45':'-45'}deg)`,top:`${endY-(verticalDirection===-1?2:17)}px`});
          createLine({left:`${startX+halfwayX+15}px`,top:`${endY}px`,width:`${halfwayX-15}px`});
        }}};

    const drawLinesForAllTechs = () => {
      techsData.forEach(group => {
        group.techs?.forEach(tech => {
          tech.prerequisites?.forEach(prerequisiteName => {
          const techItem1 = document.querySelector(`.techboxitem[data-tech-name="${prerequisiteName}"]`);
          const techItem2 = document.querySelector(`.techboxitem[data-tech-name="${tech.name}"]`);
            if (techItem1 && techItem2){drawLineBetweenTechs(techItem1, techItem2)}})})})};

    function addHoverEffectToTechItems() {
      document.querySelectorAll('.techboxitem[id="tree-branch"]').forEach(item => {
        item.addEventListener('mouseenter', () => updateLineHover(item, true));
        item.addEventListener('mouseleave', () => updateLineHover(item, false))})};

    function updateLineHover(item, isHover) {
      if (!isPopupOpen) {
        const hoveredTechName = item.dataset.techName;
        document.querySelectorAll('.line').forEach(line => {
          if (line.dataset.connectedTech.includes(hoveredTechName)) {
            line.classList.toggle('line-hovered', isHover)}})}};

    async function getImageByNameFromFolder(folder, name) {
      try {
        const res = await fetch(`icons/${folder}/${name}`);
        if (!res.ok) throw new Error(`Image not found: ${name}`);
        return getImageAsBase64(await res.blob());
      } catch (err) {
        console.error("Image fetch error:", err);
        throw err}};

    function getImageAsBase64(blob) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onloadend = () => res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(blob)})}

    function tintImageBase64(b64, color, cb) {
      const i = new Image(); i.src = `data:image/png;base64,${b64}`;
      i.onload = () => {
        const c = Object.assign(document.createElement('canvas'), {width: i.width, height: i.height}),
              x = c.getContext('2d');
        x.drawImage(i, 0, 0);
        x.globalCompositeOperation = "source-in";
        x.fillStyle = color;
        x.fillRect(0, 0, c.width, c.height);
        cb(c.toDataURL("image/png"))}};

    function applyInlineStyle(el, styles) {
      if (styles && Object.keys(styles).length) {
        Object.entries(styles).forEach(([k, v]) => el.style[k] = v)}};

    function createTechItem(folderKeyword, techName, imageName, style = "blue", parentContainer = null, positionTop = null, styleOptions = {}, target = null, colorize = null) {
      const techItem = document.createElement('div');
      techItem.classList.add('techboxitem');
      if (positionTop !== null) {
        Object.assign(techItem.style, { position: 'absolute', top: `${positionTop}px` });
        techItem.setAttribute('data-tech-name', techName)};

      const createElement = (tag, className, innerHTML = "") => {
        const el = document.createElement(tag);
        el.classList.add(className);
        if (innerHTML) el.innerHTML = innerHTML;
        return el};

      const addStyleClass = (el, styleKeyword, target) => {
        const className = `${styleKeyword}-style-${target}`;
        el.classList.add(className)};

      if (["box","token2"].includes(target)){applyInlineStyle(techItem, styleOptions)};
      addStyleClass(techItem, style, "box");

      let imageContainer;
      if (imageName) {
        imageContainer = createElement('div', 'token-container');

        getImageByNameFromFolder(folderKeyword, `${imageName}.png`).then(base64 => {
          if (colorize) {
            tintImageBase64(base64, colorize, (tintedBase64) => {
              const img = createElement('img', 'tech-icon');
              img.src = tintedBase64;
              imageContainer.appendChild(img);
              techItem.appendChild(imageContainer);
            });
          } else {
            const img = createElement('img', 'tech-icon');
            img.src = `data:image/png;base64,${base64}`;
            imageContainer.appendChild(img);
            techItem.appendChild(imageContainer);
          }

          if (["token", "token2"].includes(target)) {
            applyInlineStyle(imageContainer, styleOptions);
          }
          addStyleClass(imageContainer, style, "token");
        });
      }


      if (techName) {
        const nameEl = createElement('div', 'tech-name', techName);
        techItem.appendChild(nameEl);
        if (target === "text") applyInlineStyle(nameEl, styleOptions);
        addStyleClass(nameEl, style, "text")};

      parentContainer?.appendChild(techItem);
      return techItem};

    function applyInlineStyle(el, styles) {
      if (styles && Object.keys(styles).length) {
        Object.entries(styles).forEach(([k, v]) => el.style[k] = v)}};

    //SHOW TECH DETAILS
    function showTechDetails(tech, group, techItem) {
      document.querySelector('.tech-tree-container').classList.add('freeze');
      techItem.classList.add('hovered');

    const techpopup = document.getElementById('techPopup'); //techEra

function createInfoBar({ relatedItems, iconType, barLabel, styleGroup }, override) {
  function getBorderColorFromClass(className) {
    for (const sheet of document.styleSheets) {
      for (const rule of sheet.cssRules || []) {
        if (rule.selectorText === '.' + className + '-style-box') {
          return rule.style.borderColor}}}return null};

  const colorize = getBorderColorFromClass(styleGroup);
  const bar = createTechItem("OtherIcons", null, barLabel, styleGroup, techpopup, null, { width: '100%' }, "box", colorize);

  if (relatedItems.length) {
    const groups = {}, replacedSet = new Set(relatedItems.map(i => i.replaces).filter(Boolean));

    relatedItems.forEach(i => {
      const isUnique = !!i.uniqueTo, isReplaced = replacedSet.has(i.name);
      const parent = isUnique
        ? createTechItem(null, null, null, styleGroup, bar, null, null, null)
        : bar;
      const item = !isReplaced
        ? createTechItem(iconType, i.name, override || i.name, styleGroup, parent, null, null, null, colorize)
        : null;

      if (isUnique) {
        const n = nationsData.find(n => n.name === i.uniqueTo);
        if (n) {
          createTechItem("NationIcons", i.uniqueTo, i.uniqueTo, null, parent, null, {
            backgroundColor: `rgb(${n.outerColor?.join(',')})`,
            borderColor: `rgb(${n.innerColor?.join(',')})`,
            color: `rgb(${n.innerColor?.join(',')})`}, "token2", `rgb(${n.innerColor?.join(',')})`)}};

      if (i.replaces) {
        if (!groups[i.replaces]) {
          groups[i.replaces] = {
            replaced: createTechItem(iconType, i.replaces, i.replaces, styleGroup, bar, null, null, null, colorize),
            replacers: []}}
        groups[i.replaces].replacers.push(isUnique ? parent : item)}});

    Object.values(groups).forEach(g => {
      const c = createTechItem(null, null, null, styleGroup, bar, null, {
        display: 'inline-block',
        flexWrap: 'wrap',
        flexDirection: 'row'
      }, "box");
      c.appendChild(g.replaced);
      g.replacers.forEach(r => c.appendChild(r))})}};

    //cost and era
    techpopup.innerHTML = '';
    const close = document.createElement('button');
    close.className = 'close-btn';
    close.textContent = 'X';  
    close.onclick = closePopup;
    techpopup.appendChild(close)

    const costera = createTechItem(null,null,null,"blank",techpopup);
    createTechItem("EmojiIcons", group.era || "~","Turn","blue",costera,null,null,null,"blue");
    createTechItem("EmojiIcons", group.techCost || "~","Science","science",costera);

    const fbholder = createTechItem(null,null,null,"blank",techpopup);
    const backward = createTechItem("OtherIcons",null,"BackArrow","blue",fbholder,null,{flexDirection:'row'},"box","blue");
      tech.prerequisites?.forEach(prerequisiteName => {
      createTechItem("TechIcons",prerequisiteName,prerequisiteName,"blue",backward,null,null,null,"blue")});
    const forward = createTechItem("OtherIcons",null,"ForwardArrow","blue",fbholder,null,null,"box","blue");
    techsData.forEach(techGroup => {
    techGroup.techs?.forEach(techItem => {
    if (techItem.prerequisites?.includes(tech.name)) {
      createTechItem("TechIcons",techItem.name,techItem.name,"blue",forward,null,null,null,"blue")
      }})});
    //name
    createTechItem("TechIcons",tech.name,tech.name,"blue",techpopup,null,{fontSize: '36px'},"text","blue");

    //quote
    createTechItem("TechIcons",tech.quote,null,"quote",techpopup,null,null,null);

    const uniqueObjects = tech.uniques?.map(unique => ({ name: unique })) || [];
    createInfoBar({
      relatedItems: uniqueObjects,
      iconType: "UniqueIcons",
      barLabel: "ExclamationMark",
      styleGroup: "yellow"}, "Fallback");
    const relatedBuildings = buildingsData.filter(b => b.requiredTech === tech.name && !b.isWonder && !b.isNationalWonder);
    createInfoBar({
      relatedItems: relatedBuildings,
      iconType: "BuildingIcons",
      barLabel: "Cities",
      styleGroup: "grey"});
    const relatedWonders = buildingsData.filter(b => b.requiredTech === tech.name && (b.isWonder || b.isNationalWonder));
    createInfoBar({
      relatedItems: relatedWonders,
      iconType: "BuildingIcons",
      barLabel: "Wonders",
      styleGroup: "purple"});
    const relatedUnits = unitsData.filter(unit => unit.requiredTech === tech.name);
    createInfoBar({
      relatedItems: relatedUnits,
      iconType: "UnitIcons",
      barLabel: "Shield",
      styleGroup: "red"});
    const relatedTileImprovements = tileImprovementsData.filter(tile => tile.techRequired === tech.name);
    createInfoBar({
      relatedItems: relatedTileImprovements,
      iconType: "ImprovementIcons",
      barLabel: "Improvements",
      styleGroup: "green"});

    const popup = document.getElementById('techPopup');
    popup.style.display = 'inline-flex';
    popup.style.flexDirection = 'column';
    isPopupOpen = true;
    selectedTechItem = techItem;
    document.body.classList.add('no-hover');
    selectedTechItem.classList.add('hovered');
  }
    function closePopup() {
      document.getElementById('techPopup').style.display = 'none';
      isPopupOpen = false;
      selectedTechItem?.classList.remove('hovered');
      document.body.classList.remove('no-hover');
      document.querySelectorAll('.line').forEach(line => line.classList.remove('line-hovered'));
      document.querySelector('.tech-tree-container').classList.remove('freeze');
    }
    loadJsonFiles().then(() => {
    createTechTree()});
  </script>
  </body>
</html>